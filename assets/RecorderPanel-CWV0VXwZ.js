import{_ as G}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{l as ae,a7 as N,o as I,x as Y,r as V,i as R,C as U,ab as ne,j as $,a0 as D,a as p,p as W,ad as J,a1 as oe,al as le,B as T,M as z,c as re,w as b,b as B,t as _,e as A,f as ie,V as q,A as F}from"./index-DhQRLbW3.js";import{V as se}from"./VCard-UVDnMe1Q.js";import{V as ue}from"./VChip-DdKD4VrS.js";import{u as K,V as E,m as Q,a as ce}from"./VOverlay-DC4qDW8R.js";import{f as X}from"./forwardRefs-BOMNi2Up.js";const de=["width","height"],fe={__name:"PitchCurveChart",props:{nativeCurve:{type:Array,default:()=>[]},userCurve:{type:Array,default:()=>[]},width:{type:Number,default:320},height:{type:Number,default:120}},setup(e){const o=e,i=V(null);function u(){const l=i.value;if(!l)return;const t=l.getContext("2d");t.clearRect(0,0,o.width,o.height);const n=[...o.nativeCurve.filter(d=>d.freq>0).map(d=>d.freq),...o.userCurve.filter(d=>d.freq>0).map(d=>d.freq)];if(n.length===0)return;const f=Math.min(...n)*.85,s=Math.max(...n)*1.15,r={top:8,bottom:8,left:4,right:4},a=o.width-r.left-r.right,g=o.height-r.top-r.bottom;function v(d){return r.top+g-(d-f)/(s-f)*g}function m(d,y){if(d.length===0)return;const x=d[d.length-1].time||1;t.beginPath(),t.strokeStyle=y,t.lineWidth=2.5,t.lineJoin="round",t.lineCap="round";let S=!1;for(const P of d){if(P.freq===0){S=!1;continue}const k=r.left+P.time/x*a,M=v(P.freq);S?t.lineTo(k,M):(t.moveTo(k,M),S=!0)}t.stroke(),t.fillStyle=y;for(const P of d){if(P.freq===0)continue;const k=r.left+P.time/x*a,M=v(P.freq);t.beginPath(),t.arc(k,M,3,0,Math.PI*2),t.fill()}}t.strokeStyle="rgba(255,255,255,0.05)",t.lineWidth=1,t.beginPath(),t.moveTo(r.left,o.height/2),t.lineTo(o.width-r.right,o.height/2),t.stroke(),m(o.nativeCurve,"#22d3ee"),m(o.userCurve,"#a78bfa")}return ae(u),N(()=>[o.nativeCurve,o.userCurve],u,{deep:!0}),(l,t)=>(I(),Y("canvas",{ref_key:"canvas",ref:i,width:e.width,height:e.height,class:"pitch-canvas"},null,8,de))}},ve=G(fe,[["__scopeId","data-v-8d5f52f4"]]);function L(e,{frameMs:o=20,minHz:i=75,maxHz:u=600}={}){const l=e.sampleRate,t=e.getChannelData(0),n=Math.round(o/1e3*l),f=[];for(let s=0;s+n<=t.length;s+=n){const r=t.slice(s,s+n),a=me(r,l,i,u);f.push({time:s/l,freq:a})}return f}function me(e,o,i,u){const l=e.length,t=Math.floor(o/u),n=Math.floor(o/i);let f=0;for(let a=0;a<l;a++)f+=e[a]*e[a];if(f/=l,f<1e-6)return 0;let s=0,r=-1;for(let a=t;a<=Math.min(n,l-1);a++){let g=0;for(let v=0;v<l-a;v++)g+=e[v]*e[v+a];g/=(l-a)*f,g>r&&(r=g,s=a)}return s===0||r<.3?0:o/s}async function O(e){const o=window.AudioContext||window.webkitAudioContext,i=new o,u=e instanceof Blob?await e.arrayBuffer():e;return i.decodeAudioData(u)}function ge(e,o){const i=e.filter(a=>a.freq>0).map(a=>a.freq),u=o.filter(a=>a.freq>0).map(a=>a.freq);if(i.length===0||u.length===0)return null;const l=a=>{const g=a.reduce((v,m)=>v+m,0)/a.length;return a.map(v=>12*Math.log2(v/g))},t=l(i),n=l(u),s=he(t,n)/Math.max(t.length,n.length),r=Math.max(0,Math.min(100,100-s*8));return Math.round(r)}function he(e,o){const i=e.length,u=o.length,l=Array.from({length:i+1},()=>new Float32Array(u+1).fill(1/0));l[0][0]=0;for(let t=1;t<=i;t++)for(let n=1;n<=u;n++){const f=Math.abs(e[t-1]-o[n-1]);l[t][n]=f+Math.min(l[t-1][n],l[t][n-1],l[t-1][n-1])}return l[i][u]}const Z=W({fullscreen:Boolean,scrollable:Boolean,...J(Q({captureFocus:!0,origin:"center center",scrollStrategy:"block",transition:{component:ce},zIndex:2400,retainFocus:!0}),["disableInitialFocus"])},"VDialog"),j=R()({name:"VDialog",props:Z(),emits:{"update:modelValue":e=>!0,afterEnter:()=>!0,afterLeave:()=>!0},setup(e,o){let{emit:i,slots:u}=o;const l=U(e,"modelValue"),{scopeId:t}=K(),n=V();function f(){var r;i("afterEnter"),(e.scrim||e.retainFocus)&&((r=n.value)!=null&&r.contentEl)&&!n.value.contentEl.contains(document.activeElement)&&n.value.contentEl.focus({preventScroll:!0})}function s(){i("afterLeave")}return N(l,async r=>{var a;r||(await ne(),(a=n.value.activatorEl)==null||a.focus({preventScroll:!0}))}),$(()=>{const r=E.filterProps(e),a=D({"aria-haspopup":"dialog"},e.activatorProps),g=D({tabindex:-1},e.contentProps);return p(E,D({ref:n,class:["v-dialog",{"v-dialog--fullscreen":e.fullscreen,"v-dialog--scrollable":e.scrollable},e.class],style:e.style},r,{modelValue:l.value,"onUpdate:modelValue":v=>l.value=v,"aria-modal":"true",activatorProps:a,contentProps:g,height:e.fullscreen?void 0:e.height,width:e.fullscreen?void 0:e.width,maxHeight:e.fullscreen?void 0:e.maxHeight,maxWidth:e.fullscreen?void 0:e.maxWidth,role:"dialog",onAfterEnter:f,onAfterLeave:s},t),{activator:u.activator,default:function(){for(var v=arguments.length,m=new Array(v),d=0;d<v;d++)m[d]=arguments[d];return p(oe,{root:"VDialog"},{default:()=>{var y;return[(y=u.default)==null?void 0:y.call(u,...m)]}})}})}),X({},n)}}),pe=W({inset:Boolean,...Z({transition:"bottom-sheet-transition"})},"VBottomSheet"),ye=R()({name:"VBottomSheet",props:pe(),emits:{"update:modelValue":e=>!0},setup(e,o){let{slots:i}=o;const u=U(e,"modelValue");return $(()=>{const l=j.filterProps(e);return p(j,D(l,{contentClass:["v-bottom-sheet__content",e.contentClass],modelValue:u.value,"onUpdate:modelValue":t=>u.value=t,class:["v-bottom-sheet",{"v-bottom-sheet--inset":e.inset},e.class],style:e.style}),i)}),{}}}),be=W({id:String,interactive:Boolean,text:String,...J(Q({closeOnBack:!1,location:"end",locationStrategy:"connected",eager:!0,minWidth:0,offset:10,openOnClick:!1,openOnHover:!0,origin:"auto",scrim:!1,scrollStrategy:"reposition",transition:null}),["absolute","retainFocus","captureFocus","disableInitialFocus"])},"VTooltip"),H=R()({name:"VTooltip",props:be(),emits:{"update:modelValue":e=>!0},setup(e,o){let{slots:i}=o;const u=U(e,"modelValue"),{scopeId:l}=K(),t=le(),n=z(()=>e.id||`v-tooltip-${t}`),f=V(),s=T(()=>e.location.split(" ").length>1?e.location:e.location+" center"),r=T(()=>e.origin==="auto"||e.origin==="overlap"||e.origin.split(" ").length>1||e.location.split(" ").length>1?e.origin:e.origin+" center"),a=z(()=>e.transition!=null?e.transition:u.value?"scale-transition":"fade-transition"),g=T(()=>D({"aria-describedby":n.value},e.activatorProps));return $(()=>{const v=E.filterProps(e);return p(E,D({ref:f,class:["v-tooltip",{"v-tooltip--interactive":e.interactive},e.class],style:e.style,id:n.value},v,{modelValue:u.value,"onUpdate:modelValue":m=>u.value=m,transition:a.value,absolute:!0,location:s.value,origin:r.value,role:"tooltip",activatorProps:g.value,_disableGlobalStack:!0},l),{activator:i.activator,default:function(){var x;for(var m=arguments.length,d=new Array(m),y=0;y<m;y++)d[y]=arguments[y];return((x=i.default)==null?void 0:x.call(i,...d))??e.text}})}),X({},f)}}),xe={class:"text-body-1 font-weight-medium text-center mb-4 px-2",style:{"line-height":"1.5"}},Ve={key:0,class:"text-center mb-4"},we={class:"text-caption text-medium-emphasis mt-1"},Ce={class:"d-flex align-center justify-center gap-3 mb-4"},Pe={class:"d-flex gap-3"},Ae={__name:"RecorderPanel",props:{modelValue:Boolean,sentence:{type:String,default:""},nativeAudioB64:{type:String,default:""}},emits:["update:modelValue","close","accept"],setup(e,{emit:o}){const i=e,u=o,l=T({get:()=>i.modelValue,set:h=>u("update:modelValue",h)}),t=V([]),n=V([]),f=V(null),s=V(null),r=V(!1),a=V(!1),g=V(!1),v=V(!1);let m=null,d=null,y=null,x=null;function S(){if(!x||x.state==="closed"){const h=window.AudioContext||window.webkitAudioContext;x=new h}return x.state==="suspended"&&x.resume(),x}N(()=>[i.modelValue,i.nativeAudioB64],async([h])=>{if(!h||(s.value=null,n.value=[],f.value=null,t.value=[],!i.nativeAudioB64))return;const c=Uint8Array.from(atob(i.nativeAudioB64),w=>w.charCodeAt(0));d=await O(c.buffer),t.value=L(d)});async function P(){if(!d||g.value)return;g.value=!0;const h=S(),c=h.createBufferSource();c.buffer=d,c.connect(h.destination),c.start(),c.onended=()=>{g.value=!1}}async function k(){if(!f.value||v.value)return;v.value=!0;const h=S(),c=await f.value.arrayBuffer(),w=await h.decodeAudioData(c),C=h.createBufferSource();C.buffer=w,C.connect(h.destination),C.start(),C.onended=()=>{v.value=!1}}async function M(){if(r.value){m==null||m.stop();return}const h=await navigator.mediaDevices.getUserMedia({audio:!0}),c=["audio/webm","audio/mp4"].find(C=>MediaRecorder.isTypeSupported(C))??"",w=[];m=new MediaRecorder(h,c?{mimeType:c}:{}),m.ondataavailable=C=>w.push(C.data),m.onstop=async()=>{h.getTracks().forEach(C=>C.stop()),r.value=!1,a.value=!0,f.value=new Blob(w,{type:c||"audio/mp4"}),y=await O(await f.value.arrayBuffer()),n.value=L(y),t.value.length>0&&(s.value=ge(t.value,n.value)),a.value=!1},m.start(),r.value=!0}const ee=T(()=>s.value===null?"grey":s.value>=80?"success":s.value>=55?"warning":"error"),te=T(()=>s.value===null?"":s.value>=80?"Excellent intonation!":s.value>=55?"Good — keep practicing":"Keep trying — record again");return(h,c)=>(I(),re(ye,{modelValue:l.value,"onUpdate:modelValue":c[2]||(c[2]=w=>l.value=w),"max-width":"600"},{default:b(()=>[p(se,{class:"pa-4 pb-6"},{default:b(()=>[B("div",xe,_(e.sentence),1),c[7]||(c[7]=B("div",{class:"pitch-legend mb-1 d-flex gap-4 justify-center text-caption"},[B("span",{style:{color:"#22d3ee"}},"— Native"),B("span",{style:{color:"#a78bfa"}},"— You")],-1)),p(ve,{"native-curve":t.value,"user-curve":n.value,height:100,class:"mb-4"},null,8,["native-curve","user-curve"]),s.value!==null?(I(),Y("div",Ve,[p(ue,{color:ee.value,variant:"tonal",size:"large",class:"text-h6 font-weight-bold px-6"},{default:b(()=>[A(_(s.value)+"% ",1)]),_:1},8,["color"]),B("div",we,_(te.value),1)])):ie("",!0),B("div",Ce,[p(q,{icon:"",color:g.value?"primary":void 0,variant:"tonal",onClick:P},{default:b(()=>[p(F,null,{default:b(()=>[A(_(g.value?"mdi-stop":"mdi-volume-high"),1)]),_:1}),p(H,{activator:"parent"},{default:b(()=>[...c[3]||(c[3]=[A("Play native",-1)])]),_:1})]),_:1},8,["color"]),p(q,{icon:"",size:"x-large",color:r.value?"error":"primary",variant:r.value?"elevated":"tonal",onClick:M,loading:a.value},{default:b(()=>[p(F,null,{default:b(()=>[A(_(r.value?"mdi-stop":"mdi-microphone"),1)]),_:1})]),_:1},8,["color","variant","loading"]),p(q,{icon:"",color:v.value?"secondary":void 0,variant:"tonal",disabled:!f.value,onClick:k},{default:b(()=>[p(F,null,{default:b(()=>[A(_(v.value?"mdi-stop":"mdi-account-voice"),1)]),_:1}),p(H,{activator:"parent"},{default:b(()=>[...c[4]||(c[4]=[A("Play your recording",-1)])]),_:1})]),_:1},8,["color","disabled"])]),B("div",Pe,[p(q,{variant:"tonal",flex:"1",class:"flex-1",onClick:c[0]||(c[0]=w=>h.$emit("close"))},{default:b(()=>[...c[5]||(c[5]=[A(" Close ",-1)])]),_:1}),p(q,{color:"primary",flex:"1",class:"flex-1",disabled:s.value===null,onClick:c[1]||(c[1]=w=>h.$emit("accept",s.value))},{default:b(()=>[...c[6]||(c[6]=[A(" Accept ",-1)])]),_:1},8,["disabled"])])]),_:1})]),_:1},8,["modelValue"]))}},Te=G(Ae,[["__scopeId","data-v-d0f770cd"]]);export{Te as R,H as V};
