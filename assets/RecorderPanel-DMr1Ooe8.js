import{_ as G}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{l as ae,a7 as N,o as I,x as Y,r as V,i as R,C as U,ab as ne,j as $,a0 as _,a as h,p as W,ad as J,a1 as oe,al as le,B as D,M as z,c as re,w as b,b as A,t as M,e as P,f as ie,V as q,A as F}from"./index-CtLIZ_KS.js";import{V as se}from"./VCard-CYj_gB-H.js";import{V as ue}from"./VChip-BAFSQNr0.js";import{u as K,V as E,m as Q,a as ce}from"./VOverlay-D_31h_7L.js";import{f as X}from"./forwardRefs-BOMNi2Up.js";const de=["width","height"],fe={__name:"PitchCurveChart",props:{nativeCurve:{type:Array,default:()=>[]},userCurve:{type:Array,default:()=>[]},width:{type:Number,default:320},height:{type:Number,default:120}},setup(e){const o=e,i=V(null);function d(){const l=i.value;if(!l)return;const t=l.getContext("2d");t.clearRect(0,0,o.width,o.height);const n=[...o.nativeCurve.filter(u=>u.freq>0).map(u=>u.freq),...o.userCurve.filter(u=>u.freq>0).map(u=>u.freq)];if(n.length===0)return;const f=Math.min(...n)*.85,s=Math.max(...n)*1.15,r={top:8,bottom:8,left:4,right:4},a=o.width-r.left-r.right,g=o.height-r.top-r.bottom;function v(u){return r.top+g-(u-f)/(s-f)*g}function m(u,y){if(u.length===0)return;const C=u[u.length-1].time||1;t.beginPath(),t.strokeStyle=y,t.lineWidth=2.5,t.lineJoin="round",t.lineCap="round";let B=!1;for(const w of u){if(w.freq===0){B=!1;continue}const S=r.left+w.time/C*a,k=v(w.freq);B?t.lineTo(S,k):(t.moveTo(S,k),B=!0)}t.stroke(),t.fillStyle=y;for(const w of u){if(w.freq===0)continue;const S=r.left+w.time/C*a,k=v(w.freq);t.beginPath(),t.arc(S,k,3,0,Math.PI*2),t.fill()}}t.strokeStyle="rgba(255,255,255,0.05)",t.lineWidth=1,t.beginPath(),t.moveTo(r.left,o.height/2),t.lineTo(o.width-r.right,o.height/2),t.stroke(),m(o.nativeCurve,"#22d3ee"),m(o.userCurve,"#a78bfa")}return ae(d),N(()=>[o.nativeCurve,o.userCurve],d,{deep:!0}),(l,t)=>(I(),Y("canvas",{ref_key:"canvas",ref:i,width:e.width,height:e.height,class:"pitch-canvas"},null,8,de))}},ve=G(fe,[["__scopeId","data-v-8d5f52f4"]]);function L(e,{frameMs:o=20,minHz:i=75,maxHz:d=600}={}){const l=e.sampleRate,t=e.getChannelData(0),n=Math.round(o/1e3*l),f=[];for(let s=0;s+n<=t.length;s+=n){const r=t.slice(s,s+n),a=me(r,l,i,d);f.push({time:s/l,freq:a})}return f}function me(e,o,i,d){const l=e.length,t=Math.floor(o/d),n=Math.floor(o/i);let f=0;for(let a=0;a<l;a++)f+=e[a]*e[a];if(f/=l,f<1e-6)return 0;let s=0,r=-1;for(let a=t;a<=Math.min(n,l-1);a++){let g=0;for(let v=0;v<l-a;v++)g+=e[v]*e[v+a];g/=(l-a)*f,g>r&&(r=g,s=a)}return s===0||r<.3?0:o/s}async function O(e){const o=new AudioContext,i=e instanceof Blob?await e.arrayBuffer():e;return o.decodeAudioData(i)}function ge(e,o){const i=e.filter(a=>a.freq>0).map(a=>a.freq),d=o.filter(a=>a.freq>0).map(a=>a.freq);if(i.length===0||d.length===0)return null;const l=a=>{const g=a.reduce((v,m)=>v+m,0)/a.length;return a.map(v=>12*Math.log2(v/g))},t=l(i),n=l(d),s=he(t,n)/Math.max(t.length,n.length),r=Math.max(0,Math.min(100,100-s*8));return Math.round(r)}function he(e,o){const i=e.length,d=o.length,l=Array.from({length:i+1},()=>new Float32Array(d+1).fill(1/0));l[0][0]=0;for(let t=1;t<=i;t++)for(let n=1;n<=d;n++){const f=Math.abs(e[t-1]-o[n-1]);l[t][n]=f+Math.min(l[t-1][n],l[t][n-1],l[t-1][n-1])}return l[i][d]}const Z=W({fullscreen:Boolean,scrollable:Boolean,...J(Q({captureFocus:!0,origin:"center center",scrollStrategy:"block",transition:{component:ce},zIndex:2400,retainFocus:!0}),["disableInitialFocus"])},"VDialog"),j=R()({name:"VDialog",props:Z(),emits:{"update:modelValue":e=>!0,afterEnter:()=>!0,afterLeave:()=>!0},setup(e,o){let{emit:i,slots:d}=o;const l=U(e,"modelValue"),{scopeId:t}=K(),n=V();function f(){var r;i("afterEnter"),(e.scrim||e.retainFocus)&&((r=n.value)!=null&&r.contentEl)&&!n.value.contentEl.contains(document.activeElement)&&n.value.contentEl.focus({preventScroll:!0})}function s(){i("afterLeave")}return N(l,async r=>{var a;r||(await ne(),(a=n.value.activatorEl)==null||a.focus({preventScroll:!0}))}),$(()=>{const r=E.filterProps(e),a=_({"aria-haspopup":"dialog"},e.activatorProps),g=_({tabindex:-1},e.contentProps);return h(E,_({ref:n,class:["v-dialog",{"v-dialog--fullscreen":e.fullscreen,"v-dialog--scrollable":e.scrollable},e.class],style:e.style},r,{modelValue:l.value,"onUpdate:modelValue":v=>l.value=v,"aria-modal":"true",activatorProps:a,contentProps:g,height:e.fullscreen?void 0:e.height,width:e.fullscreen?void 0:e.width,maxHeight:e.fullscreen?void 0:e.maxHeight,maxWidth:e.fullscreen?void 0:e.maxWidth,role:"dialog",onAfterEnter:f,onAfterLeave:s},t),{activator:d.activator,default:function(){for(var v=arguments.length,m=new Array(v),u=0;u<v;u++)m[u]=arguments[u];return h(oe,{root:"VDialog"},{default:()=>{var y;return[(y=d.default)==null?void 0:y.call(d,...m)]}})}})}),X({},n)}}),pe=W({inset:Boolean,...Z({transition:"bottom-sheet-transition"})},"VBottomSheet"),ye=R()({name:"VBottomSheet",props:pe(),emits:{"update:modelValue":e=>!0},setup(e,o){let{slots:i}=o;const d=U(e,"modelValue");return $(()=>{const l=j.filterProps(e);return h(j,_(l,{contentClass:["v-bottom-sheet__content",e.contentClass],modelValue:d.value,"onUpdate:modelValue":t=>d.value=t,class:["v-bottom-sheet",{"v-bottom-sheet--inset":e.inset},e.class],style:e.style}),i)}),{}}}),be=W({id:String,interactive:Boolean,text:String,...J(Q({closeOnBack:!1,location:"end",locationStrategy:"connected",eager:!0,minWidth:0,offset:10,openOnClick:!1,openOnHover:!0,origin:"auto",scrim:!1,scrollStrategy:"reposition",transition:null}),["absolute","retainFocus","captureFocus","disableInitialFocus"])},"VTooltip"),H=R()({name:"VTooltip",props:be(),emits:{"update:modelValue":e=>!0},setup(e,o){let{slots:i}=o;const d=U(e,"modelValue"),{scopeId:l}=K(),t=le(),n=z(()=>e.id||`v-tooltip-${t}`),f=V(),s=D(()=>e.location.split(" ").length>1?e.location:e.location+" center"),r=D(()=>e.origin==="auto"||e.origin==="overlap"||e.origin.split(" ").length>1||e.location.split(" ").length>1?e.origin:e.origin+" center"),a=z(()=>e.transition!=null?e.transition:d.value?"scale-transition":"fade-transition"),g=D(()=>_({"aria-describedby":n.value},e.activatorProps));return $(()=>{const v=E.filterProps(e);return h(E,_({ref:f,class:["v-tooltip",{"v-tooltip--interactive":e.interactive},e.class],style:e.style,id:n.value},v,{modelValue:d.value,"onUpdate:modelValue":m=>d.value=m,transition:a.value,absolute:!0,location:s.value,origin:r.value,role:"tooltip",activatorProps:g.value,_disableGlobalStack:!0},l),{activator:i.activator,default:function(){var C;for(var m=arguments.length,u=new Array(m),y=0;y<m;y++)u[y]=arguments[y];return((C=i.default)==null?void 0:C.call(i,...u))??e.text}})}),X({},f)}}),xe={class:"text-body-1 font-weight-medium text-center mb-4 px-2",style:{"line-height":"1.5"}},Ve={key:0,class:"text-center mb-4"},Ce={class:"text-caption text-medium-emphasis mt-1"},we={class:"d-flex align-center justify-center gap-3 mb-4"},Pe={class:"d-flex gap-3"},Ae={__name:"RecorderPanel",props:{modelValue:Boolean,sentence:{type:String,default:""},nativeAudioB64:{type:String,default:""}},emits:["update:modelValue","close","accept"],setup(e,{emit:o}){const i=e,d=o,l=D({get:()=>i.modelValue,set:p=>d("update:modelValue",p)}),t=V([]),n=V([]),f=V(null),s=V(null),r=V(!1),a=V(!1),g=V(!1),v=V(!1);let m=null,u=null,y=null,C=null;function B(){return(!C||C.state==="closed")&&(C=new AudioContext),C}N(()=>[i.modelValue,i.nativeAudioB64],async([p])=>{if(!p||(s.value=null,n.value=[],f.value=null,t.value=[],!i.nativeAudioB64))return;const c=Uint8Array.from(atob(i.nativeAudioB64),x=>x.charCodeAt(0));u=await O(c.buffer),t.value=L(u)});async function w(){if(!u||g.value)return;g.value=!0;const p=B(),c=p.createBufferSource();c.buffer=u,c.connect(p.destination),c.start(),c.onended=()=>{g.value=!1}}async function S(){if(!f.value||v.value)return;v.value=!0;const p=B(),c=await f.value.arrayBuffer(),x=await p.decodeAudioData(c),T=p.createBufferSource();T.buffer=x,T.connect(p.destination),T.start(),T.onended=()=>{v.value=!1}}async function k(){if(r.value){m==null||m.stop();return}const p=await navigator.mediaDevices.getUserMedia({audio:!0}),c=[];m=new MediaRecorder(p,{mimeType:"audio/webm"}),m.ondataavailable=x=>c.push(x.data),m.onstop=async()=>{p.getTracks().forEach(x=>x.stop()),r.value=!1,a.value=!0,f.value=new Blob(c,{type:"audio/webm"}),y=await O(await f.value.arrayBuffer()),n.value=L(y),t.value.length>0&&(s.value=ge(t.value,n.value)),a.value=!1},m.start(),r.value=!0}const ee=D(()=>s.value===null?"grey":s.value>=80?"success":s.value>=55?"warning":"error"),te=D(()=>s.value===null?"":s.value>=80?"Excellent intonation!":s.value>=55?"Good — keep practicing":"Keep trying — record again");return(p,c)=>(I(),re(ye,{modelValue:l.value,"onUpdate:modelValue":c[2]||(c[2]=x=>l.value=x),"max-width":"600"},{default:b(()=>[h(se,{class:"pa-4 pb-6"},{default:b(()=>[A("div",xe,M(e.sentence),1),c[7]||(c[7]=A("div",{class:"pitch-legend mb-1 d-flex gap-4 justify-center text-caption"},[A("span",{style:{color:"#22d3ee"}},"— Native"),A("span",{style:{color:"#a78bfa"}},"— You")],-1)),h(ve,{"native-curve":t.value,"user-curve":n.value,height:100,class:"mb-4"},null,8,["native-curve","user-curve"]),s.value!==null?(I(),Y("div",Ve,[h(ue,{color:ee.value,variant:"tonal",size:"large",class:"text-h6 font-weight-bold px-6"},{default:b(()=>[P(M(s.value)+"% ",1)]),_:1},8,["color"]),A("div",Ce,M(te.value),1)])):ie("",!0),A("div",we,[h(q,{icon:"",color:g.value?"primary":void 0,variant:"tonal",onClick:w},{default:b(()=>[h(F,null,{default:b(()=>[P(M(g.value?"mdi-stop":"mdi-volume-high"),1)]),_:1}),h(H,{activator:"parent"},{default:b(()=>[...c[3]||(c[3]=[P("Play native",-1)])]),_:1})]),_:1},8,["color"]),h(q,{icon:"",size:"x-large",color:r.value?"error":"primary",variant:r.value?"elevated":"tonal",onClick:k,loading:a.value},{default:b(()=>[h(F,null,{default:b(()=>[P(M(r.value?"mdi-stop":"mdi-microphone"),1)]),_:1})]),_:1},8,["color","variant","loading"]),h(q,{icon:"",color:v.value?"secondary":void 0,variant:"tonal",disabled:!f.value,onClick:S},{default:b(()=>[h(F,null,{default:b(()=>[P(M(v.value?"mdi-stop":"mdi-account-voice"),1)]),_:1}),h(H,{activator:"parent"},{default:b(()=>[...c[4]||(c[4]=[P("Play your recording",-1)])]),_:1})]),_:1},8,["color","disabled"])]),A("div",Pe,[h(q,{variant:"tonal",flex:"1",class:"flex-1",onClick:c[0]||(c[0]=x=>p.$emit("close"))},{default:b(()=>[...c[5]||(c[5]=[P(" Close ",-1)])]),_:1}),h(q,{color:"primary",flex:"1",class:"flex-1",disabled:s.value===null,onClick:c[1]||(c[1]=x=>p.$emit("accept",s.value))},{default:b(()=>[...c[6]||(c[6]=[P(" Accept ",-1)])]),_:1},8,["disabled"])])]),_:1})]),_:1},8,["modelValue"]))}},qe=G(Ae,[["__scopeId","data-v-3f1ec025"]]);export{qe as R,H as V};
