import{i as be,C as _e,a5 as Ve,r as d,a6 as Ce,l as pe,a7 as B,a8 as ke,j as Re,a9 as Se,a as s,a0 as te,aa as ae,ab as N,ac as Ie,B as O,p as Ne,ad as Ae,ae as Fe,b as r,F as j,af as ue,ag as Pe,k as ze,ah as Be,ai as Te,q as J,c as de,w as i,A as T,e as w,V as L,t as S,x as I,f as le,y as He,aj as Me,ak as De,d as Ee,h as Ue,o as b}from"./index-Dw079dWF.js";import{u as $e}from"./settings-BXT-QMKW.js";import{R as Ge}from"./RecorderPanel-9LWdC5rw.js";import{_ as Le}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{I as ce,a as ve,V as Oe}from"./index-CV8RJDWY.js";import{V as oe}from"./VCard-jGGMsWSY.js";import{u as je,a as Ke,V as fe,b as me,d as We,e as qe,f as Je,g as Qe,h as Xe}from"./autofocus-X9pRNoI7.js";import{f as Ye}from"./forwardRefs-BOMNi2Up.js";import{V as Ze}from"./VChip-C8PN-9LD.js";import"./VOverlay-C9zpwEHU.js";const et=Ne({autoGrow:Boolean,autofocus:Boolean,counter:[Boolean,Number,String],counterValue:Function,prefix:String,placeholder:String,persistentPlaceholder:Boolean,persistentCounter:Boolean,noResize:Boolean,rows:{type:[Number,String],default:5,validator:e=>!isNaN(parseFloat(e))},maxHeight:{type:[Number,String],validator:e=>!isNaN(parseFloat(e))},maxRows:{type:[Number,String],validator:e=>!isNaN(parseFloat(e))},suffix:String,modelModifiers:Object,...Je(),...Ae(qe(),["direction"]),...We()},"VTextarea"),tt=be()({name:"VTextarea",directives:{vIntersect:ce},inheritAttrs:!1,props:et(),emits:{"click:control":e=>!0,"mousedown:control":e=>!0,"update:focused":e=>!0,"update:modelValue":e=>!0,"update:rows":e=>!0},setup(e,Q){let{attrs:g,emit:f,slots:m}=Q;const u=_e(e,"modelValue"),{isFocused:v,focus:H,blur:V}=je(e),{onIntersect:A}=Xe(e),K=O(()=>typeof e.counterValue=="function"?e.counterValue(u.value):(u.value||"").toString().length),W=O(()=>{if(g.maxlength)return g.maxlength;if(!(!e.counter||typeof e.counter!="number"&&typeof e.counter!="string"))return e.counter}),x=d(),C=d(),p=Fe(""),h=d(),U=d(0),{platform:$}=Ve(),M=Ke(e),q=O(()=>e.persistentPlaceholder||v.value||e.active);function G(){var a;M.isSuppressing.value&&M.update(),h.value!==document.activeElement&&((a=h.value)==null||a.focus()),v.value||H()}function X(a){G(),f("click:control",a)}function F(a){f("mousedown:control",a)}function Y(a){a.stopPropagation(),G(),N(()=>{u.value="",Be(e["onClick:clear"],a)})}function Z(a){var D;const n=a.target;if(!((D=e.modelModifiers)!=null&&D.trim)){u.value=n.value;return}const c=n.value,y=n.selectionStart,P=n.selectionEnd;u.value=c,N(()=>{let z=0;c.trimStart().length===n.value.length&&(z=c.length-n.value.length),y!=null&&(n.selectionStart=y-z),P!=null&&(n.selectionEnd=P-z)})}const k=d(),_=d(Number(e.rows)),l=O(()=>["plain","underlined"].includes(e.variant));Ce(()=>{e.autoGrow||(_.value=Number(e.rows))});function t(){N(()=>{if(!h.value)return;if($.value.firefox){U.value=12;return}const{offsetWidth:a,clientWidth:n}=h.value;U.value=Math.max(0,a-n)}),e.autoGrow&&N(()=>{if(!k.value||!C.value)return;const a=getComputedStyle(k.value),n=getComputedStyle(C.value.$el),c=parseFloat(a.getPropertyValue("--v-field-padding-top"))+parseFloat(a.getPropertyValue("--v-input-padding-top"))+parseFloat(a.getPropertyValue("--v-field-padding-bottom")),y=k.value.scrollHeight,P=parseFloat(a.lineHeight),D=Math.max(parseFloat(e.rows)*P+c,parseFloat(n.getPropertyValue("--v-input-control-height"))),z=e.maxHeight?parseFloat(e.maxHeight):parseFloat(e.maxRows)*P+c||1/0,R=Ie(y??0,D,z);_.value=Math.floor((R-c)/P),p.value=ae(R)})}pe(t),B(u,t),B(()=>e.rows,t),B(()=>e.maxHeight,t),B(()=>e.maxRows,t),B(()=>e.density,t),B(_,a=>{f("update:rows",a)});let o;return B(k,a=>{a?(o=new ResizeObserver(t),o.observe(k.value)):o==null||o.disconnect()}),ke(()=>{o==null||o.disconnect()}),Re(()=>{const a=!!(m.counter||e.counter||e.counterValue),n=!!(a||m.details),[c,y]=Se(g),{modelValue:P,...D}=fe.filterProps(e),z={...me.filterProps(e),"onClick:clear":Y};return s(fe,te({ref:x,modelValue:u.value,"onUpdate:modelValue":R=>u.value=R,class:["v-textarea v-text-field",{"v-textarea--prefixed":e.prefix,"v-textarea--suffixed":e.suffix,"v-text-field--prefixed":e.prefix,"v-text-field--suffixed":e.suffix,"v-textarea--auto-grow":e.autoGrow,"v-textarea--no-resize":e.noResize||e.autoGrow,"v-input--plain-underlined":l.value},e.class],style:[{"--v-textarea-max-height":e.maxHeight?ae(e.maxHeight):void 0,"--v-textarea-scroll-bar-width":ae(U.value)},e.style]},c,D,{centerAffix:_.value===1&&!l.value,focused:v.value}),{...m,default:R=>{let{id:E,isDisabled:ne,isDirty:se,isReadonly:ge,isValid:xe,hasDetails:he}=R;return s(me,te({ref:C,style:{"--v-textarea-control-height":p.value},onClick:X,onMousedown:F,"onClick:prependInner":e["onClick:prependInner"],"onClick:appendInner":e["onClick:appendInner"]},z,{id:E.value,active:q.value||se.value,labelId:`${E.value}-label`,centerAffix:_.value===1&&!l.value,dirty:se.value||e.dirty,disabled:ne.value,focused:v.value,details:he.value,error:xe.value===!1}),{...m,default:ye=>{let{props:{class:ie,...re},controlRef:we}=ye;return r(j,null,[e.prefix&&r("span",{class:"v-text-field__prefix"},[e.prefix]),ue(r("textarea",te({ref:ee=>h.value=we.value=ee,class:ie,value:u.value,onInput:Z,autofocus:e.autofocus,readonly:ge.value,disabled:ne.value,placeholder:e.placeholder,rows:e.rows,name:M.fieldName.value,autocomplete:M.fieldAutocomplete.value,onFocus:G,onBlur:V,"aria-labelledby":`${E.value}-label`},re,y),null),[[ce,{handler:A},null,{once:!0}]]),e.autoGrow&&ue(r("textarea",{class:ze([ie,"v-textarea__sizer"]),id:`${re.id}-sizer`,"onUpdate:modelValue":ee=>u.value=ee,ref:k,readonly:!0,"aria-hidden":"true"},null),[[Pe,u.value]]),e.suffix&&r("span",{class:"v-text-field__suffix"},[e.suffix])])}})},details:n?R=>{var E;return r(j,null,[(E=m.details)==null?void 0:E.call(m,R),a&&r(j,null,[r("span",null,null),s(Qe,{active:e.persistentCounter||v.value,value:K.value,max:W.value,disabled:e.disabled},m.counter)])])}:void 0})}),Ye({},x,C,h)}}),at={class:"d-flex align-center pa-4 gap-3",style:{"border-bottom":"1px solid rgba(255,255,255,0.06)"}},lt={class:"flex-1"},ot={class:"text-body-1 font-weight-medium"},nt={class:"text-caption text-medium-emphasis"},st={key:0,class:"text-center text-medium-emphasis py-12"},it={key:0,class:"d-flex align-start gap-2"},rt={style:{"max-width":"80%"}},ut={class:"text-body-2",style:{"line-height":"1.6",color:"rgba(255,255,255,0.9)"}},dt={class:"d-flex gap-2 mt-1"},ct={key:1,class:"d-flex justify-end"},vt={class:"text-body-2",style:{"line-height":"1.6"}},ft={key:1,class:"d-flex align-center gap-2"},mt={key:0,class:"pa-4",style:{"border-top":"1px solid rgba(255,255,255,0.06)"}},pt={class:"d-flex gap-3 align-end"},gt={key:1,class:"pa-4 text-center",style:{"border-top":"1px solid rgba(255,255,255,0.06)"}},xt={__name:"ConversationView",setup(e){const Q=Ue(),g=$e(),f=d([]),m=d(null),u=d(""),v=d(!1),H=d(null),V=d(null),A=d(!1),K=d(""),W=d(""),x=d(!1),C=d(!1);let p=null,h=null;const U=[{code:"de",nativeName:"Deutsch"},{code:"fr",nativeName:"FranÃ§ais"},{code:"es",nativeName:"EspaÃ±ol"},{code:"en",nativeName:"English"}],$=O(()=>{var l;return((l=U.find(t=>t.code===g.language))==null?void 0:l.nativeName)||""});pe(M),Te(_);async function M(){v.value=!0;try{const l=await J.post("/api/conversation/start",{language:g.language,model:g.model,voice:g.voice});m.value=l.sessionId,f.value.push({role:"assistant",text:l.message.text,audio:l.message.audio}),await N(),F()}finally{v.value=!1}}async function q(){const l=u.value.trim();if(!(!l||v.value)){u.value="",f.value.push({role:"user",text:l}),v.value=!0,F();try{const t=await J.post("/api/conversation/message",{sessionId:m.value,userText:l,model:g.model,voice:g.voice});f.value.push({role:"assistant",text:t.message.text,audio:t.message.audio}),await N(),F()}finally{v.value=!1}}}async function G(l){const t=f.value[l];if(!t.audio||V.value===l)return;V.value=l;const o=Uint8Array.from(atob(t.audio),y=>y.charCodeAt(0)),a=new AudioContext,n=await a.decodeAudioData(o.buffer),c=a.createBufferSource();c.buffer=n,c.connect(a.destination),c.start(),c.onended=()=>{V.value===l&&(V.value=null)}}function X(l){const t=f.value[l];K.value=t.text,W.value=t.audio,A.value=!0}function F(){H.value&&(H.value.scrollTop=H.value.scrollHeight)}async function Y(){m.value&&await J.post("/api/conversation/end",{sessionId:m.value}).catch(()=>{}),_(),Q.push("/")}async function Z(){if(x.value){_();return}C.value=!0;try{const{client_secret:l}=await J.post("/api/realtime/token",{language:g.language,voice:g.voice});p=new RTCPeerConnection;const t=new Audio;t.autoplay=!0,p.ontrack=y=>{t.srcObject=y.streams[0]};const o=await navigator.mediaDevices.getUserMedia({audio:!0});p.addTrack(o.getTracks()[0],o),h=p.createDataChannel("oai-events"),h.onmessage=k;const a=await p.createOffer();await p.setLocalDescription(a);const c={type:"answer",sdp:await(await fetch("https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview",{method:"POST",body:a.sdp,headers:{Authorization:`Bearer ${l.value}`,"Content-Type":"application/sdp"}})).text()};await p.setRemoteDescription(c),x.value=!0}catch(l){console.error("Realtime connect error",l)}finally{C.value=!1}}function k(l){var t,o,a;try{const n=JSON.parse(l.data);n.type==="response.output_item.done"&&((a=(o=(t=n.item)==null?void 0:t.content)==null?void 0:o[0])!=null&&a.transcript)&&(f.value.push({role:"assistant",text:n.item.content[0].transcript,audio:null}),N(F)),n.type==="conversation.item.input_audio_transcription.completed"&&(f.value.push({role:"user",text:n.transcript,audio:null}),N(F))}catch{}}function _(){p&&(p.close(),p=null),h=null,x.value=!1}return(l,t)=>(b(),de(Oe,{class:"pa-0 d-flex flex-column",style:{height:"100dvh","max-width":"640px"}},{default:i(()=>[r("div",at,[s(L,{icon:"",size:"small",variant:"text",onClick:Y},{default:i(()=>[s(T,null,{default:i(()=>[...t[4]||(t[4]=[w("mdi-arrow-left",-1)])]),_:1})]),_:1}),r("div",lt,[r("div",ot,S($.value)+" Conversation ",1),r("div",nt,S(x.value?"ðŸ”´ Live":"Text mode"),1)]),s(L,{color:x.value?"error":"secondary",variant:"tonal",size:"small",onClick:Z,loading:C.value},{default:i(()=>[s(T,{start:""},{default:i(()=>[w(S(x.value?"mdi-phone-hangup":"mdi-phone"),1)]),_:1}),w(" "+S(x.value?"End call":"Go live"),1)]),_:1},8,["color","loading"])]),r("div",{ref_key:"messageList",ref:H,class:"flex-1 overflow-y-auto pa-4",style:{gap:"12px",display:"flex","flex-direction":"column"}},[f.value.length===0&&!v.value?(b(),I("div",st," Starting conversationâ€¦ ")):le("",!0),(b(!0),I(j,null,He(f.value,(o,a)=>(b(),I(j,{key:a},[o.role==="assistant"?(b(),I("div",it,[s(ve,{color:"primary",variant:"tonal",size:"32"},{default:i(()=>[s(T,{size:"18"},{default:i(()=>[...t[5]||(t[5]=[w("mdi-robot",-1)])]),_:1})]),_:1}),r("div",rt,[s(oe,{class:"pa-3 assistant-bubble",variant:"flat",style:{background:"rgba(255,255,255,0.08)"}},{default:i(()=>[r("div",ut,S(o.text),1)]),_:2},1024),r("div",dt,[s(L,{size:"x-small",variant:"text",color:V.value===a?"primary":void 0,onClick:n=>G(a),disabled:!o.audio},{default:i(()=>[s(T,{size:"16"},{default:i(()=>[w(S(V.value===a?"mdi-stop":"mdi-volume-high"),1)]),_:2},1024)]),_:2},1032,["color","onClick","disabled"]),o.audio?(b(),de(L,{key:0,size:"x-small",variant:"text",color:"secondary",onClick:n=>X(a)},{default:i(()=>[s(T,{size:"16"},{default:i(()=>[...t[6]||(t[6]=[w("mdi-microphone",-1)])]),_:1}),t[7]||(t[7]=w(" Repeat ",-1))]),_:1},8,["onClick"])):le("",!0)])])])):(b(),I("div",ct,[s(oe,{class:"pa-3 user-bubble",color:"primary",variant:"tonal",style:{"max-width":"80%"}},{default:i(()=>[r("div",vt,S(o.text),1)]),_:2},1024)]))],64))),128)),v.value?(b(),I("div",ft,[s(ve,{color:"primary",variant:"tonal",size:"32"},{default:i(()=>[s(T,{size:"18"},{default:i(()=>[...t[8]||(t[8]=[w("mdi-robot",-1)])]),_:1})]),_:1}),s(oe,{class:"pa-3",variant:"tonal",color:"surface-variant"},{default:i(()=>[s(Me,{indeterminate:"",size:"16",width:"2",color:"primary"})]),_:1})])):le("",!0)],512),x.value?(b(),I("div",gt,[s(Ze,{color:"error",variant:"tonal","prepend-icon":"mdi-microphone"},{default:i(()=>[w(" Listeningâ€¦ speak "+S($.value),1)]),_:1})])):(b(),I("div",mt,[r("div",pt,[s(tt,{modelValue:u.value,"onUpdate:modelValue":t[0]||(t[0]=o=>u.value=o),label:`Reply in ${$.value}â€¦`,rows:"1","auto-grow":"","max-rows":"4","hide-details":"",class:"flex-1",onKeydown:De(Ee(q,["exact","prevent"]),["enter"]),disabled:v.value},null,8,["modelValue","label","onKeydown","disabled"]),s(L,{icon:"",color:"primary",loading:v.value,disabled:!u.value.trim(),onClick:q},{default:i(()=>[s(T,null,{default:i(()=>[...t[9]||(t[9]=[w("mdi-send",-1)])]),_:1})]),_:1},8,["loading","disabled"])])])),s(Ge,{modelValue:A.value,"onUpdate:modelValue":t[1]||(t[1]=o=>A.value=o),sentence:K.value,"native-audio-b64":W.value,onClose:t[2]||(t[2]=o=>A.value=!1),onAccept:t[3]||(t[3]=o=>A.value=!1)},null,8,["modelValue","sentence","native-audio-b64"])]),_:1}))}},It=Le(xt,[["__scopeId","data-v-885d6311"]]);export{It as default};
