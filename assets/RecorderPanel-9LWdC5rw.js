import{_ as J}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{l as oe,a7 as N,o as E,x as $,r as V,i as R,C as U,ab as le,j as W,a0 as D,a as p,p as z,ad as K,a1 as re,al as ie,B as T,M as L,c as se,w as x,b as k,t as S,e as B,f as O,V as q,A as I}from"./index-Dw079dWF.js";import{V as ue}from"./VCard-jGGMsWSY.js";import{V as ce}from"./VChip-C8PN-9LD.js";import{u as Q,V as F,m as X,a as de}from"./VOverlay-C9zpwEHU.js";import{f as Z}from"./forwardRefs-BOMNi2Up.js";const fe=["width","height"],ve={__name:"PitchCurveChart",props:{nativeCurve:{type:Array,default:()=>[]},userCurve:{type:Array,default:()=>[]},width:{type:Number,default:320},height:{type:Number,default:120}},setup(e){const n=e,i=V(null);function c(){const l=i.value;if(!l)return;const t=l.getContext("2d");t.clearRect(0,0,n.width,n.height);const o=[...n.nativeCurve.filter(s=>s.freq>0).map(s=>s.freq),...n.userCurve.filter(s=>s.freq>0).map(s=>s.freq)];if(o.length===0)return;const f=Math.min(...o)*.85,u=Math.max(...o)*1.15,r={top:8,bottom:8,left:4,right:4},a=n.width-r.left-r.right,g=n.height-r.top-r.bottom;function v(s){return r.top+g-(s-f)/(u-f)*g}function h(s,y){if(s.length===0)return;const A=s[s.length-1].time||1;t.beginPath(),t.strokeStyle=y,t.lineWidth=2.5,t.lineJoin="round",t.lineCap="round";let C=!1;for(const w of s){if(w.freq===0){C=!1;continue}const M=r.left+w.time/A*a,_=v(w.freq);C?t.lineTo(M,_):(t.moveTo(M,_),C=!0)}t.stroke(),t.fillStyle=y;for(const w of s){if(w.freq===0)continue;const M=r.left+w.time/A*a,_=v(w.freq);t.beginPath(),t.arc(M,_,3,0,Math.PI*2),t.fill()}}t.strokeStyle="rgba(255,255,255,0.05)",t.lineWidth=1,t.beginPath(),t.moveTo(r.left,n.height/2),t.lineTo(n.width-r.right,n.height/2),t.stroke(),h(n.nativeCurve,"#22d3ee"),h(n.userCurve,"#a78bfa")}return oe(c),N(()=>[n.nativeCurve,n.userCurve],c,{deep:!0}),(l,t)=>(E(),$("canvas",{ref_key:"canvas",ref:i,width:e.width,height:e.height,class:"pitch-canvas"},null,8,fe))}},me=J(ve,[["__scopeId","data-v-8d5f52f4"]]);function j(e,{frameMs:n=20,minHz:i=75,maxHz:c=600}={}){const l=e.sampleRate,t=e.getChannelData(0),o=Math.round(n/1e3*l),f=[];for(let u=0;u+o<=t.length;u+=o){const r=t.slice(u,u+o),a=ge(r,l,i,c);f.push({time:u/l,freq:a})}return f}function ge(e,n,i,c){const l=e.length,t=Math.floor(n/c),o=Math.floor(n/i);let f=0;for(let a=0;a<l;a++)f+=e[a]*e[a];if(f/=l,f<1e-6)return 0;let u=0,r=-1;for(let a=t;a<=Math.min(o,l-1);a++){let g=0;for(let v=0;v<l-a;v++)g+=e[v]*e[v+a];g/=(l-a)*f,g>r&&(r=g,u=a)}return u===0||r<.3?0:n/u}async function H(e,n){if(!n){const c=window.AudioContext||window.webkitAudioContext;n=new c}const i=e instanceof Blob?await e.arrayBuffer():e;return n.decodeAudioData(i)}function he(e,n){const i=e.filter(a=>a.freq>0).map(a=>a.freq),c=n.filter(a=>a.freq>0).map(a=>a.freq);if(i.length===0||c.length===0)return null;const l=a=>{const g=a.reduce((v,h)=>v+h,0)/a.length;return a.map(v=>12*Math.log2(v/g))},t=l(i),o=l(c),u=pe(t,o)/Math.max(t.length,o.length),r=Math.max(0,Math.min(100,100-u*8));return Math.round(r)}function pe(e,n){const i=e.length,c=n.length,l=Array.from({length:i+1},()=>new Float32Array(c+1).fill(1/0));l[0][0]=0;for(let t=1;t<=i;t++)for(let o=1;o<=c;o++){const f=Math.abs(e[t-1]-n[o-1]);l[t][o]=f+Math.min(l[t-1][o],l[t][o-1],l[t-1][o-1])}return l[i][c]}const ee=z({fullscreen:Boolean,scrollable:Boolean,...K(X({captureFocus:!0,origin:"center center",scrollStrategy:"block",transition:{component:de},zIndex:2400,retainFocus:!0}),["disableInitialFocus"])},"VDialog"),G=R()({name:"VDialog",props:ee(),emits:{"update:modelValue":e=>!0,afterEnter:()=>!0,afterLeave:()=>!0},setup(e,n){let{emit:i,slots:c}=n;const l=U(e,"modelValue"),{scopeId:t}=Q(),o=V();function f(){var r;i("afterEnter"),(e.scrim||e.retainFocus)&&((r=o.value)!=null&&r.contentEl)&&!o.value.contentEl.contains(document.activeElement)&&o.value.contentEl.focus({preventScroll:!0})}function u(){i("afterLeave")}return N(l,async r=>{var a;r||(await le(),(a=o.value.activatorEl)==null||a.focus({preventScroll:!0}))}),W(()=>{const r=F.filterProps(e),a=D({"aria-haspopup":"dialog"},e.activatorProps),g=D({tabindex:-1},e.contentProps);return p(F,D({ref:o,class:["v-dialog",{"v-dialog--fullscreen":e.fullscreen,"v-dialog--scrollable":e.scrollable},e.class],style:e.style},r,{modelValue:l.value,"onUpdate:modelValue":v=>l.value=v,"aria-modal":"true",activatorProps:a,contentProps:g,height:e.fullscreen?void 0:e.height,width:e.fullscreen?void 0:e.width,maxHeight:e.fullscreen?void 0:e.maxHeight,maxWidth:e.fullscreen?void 0:e.maxWidth,role:"dialog",onAfterEnter:f,onAfterLeave:u},t),{activator:c.activator,default:function(){for(var v=arguments.length,h=new Array(v),s=0;s<v;s++)h[s]=arguments[s];return p(re,{root:"VDialog"},{default:()=>{var y;return[(y=c.default)==null?void 0:y.call(c,...h)]}})}})}),Z({},o)}}),ye=z({inset:Boolean,...ee({transition:"bottom-sheet-transition"})},"VBottomSheet"),be=R()({name:"VBottomSheet",props:ye(),emits:{"update:modelValue":e=>!0},setup(e,n){let{slots:i}=n;const c=U(e,"modelValue");return W(()=>{const l=G.filterProps(e);return p(G,D(l,{contentClass:["v-bottom-sheet__content",e.contentClass],modelValue:c.value,"onUpdate:modelValue":t=>c.value=t,class:["v-bottom-sheet",{"v-bottom-sheet--inset":e.inset},e.class],style:e.style}),i)}),{}}}),xe=z({id:String,interactive:Boolean,text:String,...K(X({closeOnBack:!1,location:"end",locationStrategy:"connected",eager:!0,minWidth:0,offset:10,openOnClick:!1,openOnHover:!0,origin:"auto",scrim:!1,scrollStrategy:"reposition",transition:null}),["absolute","retainFocus","captureFocus","disableInitialFocus"])},"VTooltip"),Y=R()({name:"VTooltip",props:xe(),emits:{"update:modelValue":e=>!0},setup(e,n){let{slots:i}=n;const c=U(e,"modelValue"),{scopeId:l}=Q(),t=ie(),o=L(()=>e.id||`v-tooltip-${t}`),f=V(),u=T(()=>e.location.split(" ").length>1?e.location:e.location+" center"),r=T(()=>e.origin==="auto"||e.origin==="overlap"||e.origin.split(" ").length>1||e.location.split(" ").length>1?e.origin:e.origin+" center"),a=L(()=>e.transition!=null?e.transition:c.value?"scale-transition":"fade-transition"),g=T(()=>D({"aria-describedby":o.value},e.activatorProps));return W(()=>{const v=F.filterProps(e);return p(F,D({ref:f,class:["v-tooltip",{"v-tooltip--interactive":e.interactive},e.class],style:e.style,id:o.value},v,{modelValue:c.value,"onUpdate:modelValue":h=>c.value=h,transition:a.value,absolute:!0,location:u.value,origin:r.value,role:"tooltip",activatorProps:g.value,_disableGlobalStack:!0},l),{activator:i.activator,default:function(){var A;for(var h=arguments.length,s=new Array(h),y=0;y<h;y++)s[y]=arguments[y];return((A=i.default)==null?void 0:A.call(i,...s))??e.text}})}),Z({},f)}}),we={class:"text-body-1 font-weight-medium text-center mb-4 px-2",style:{"line-height":"1.5"}},Ve={key:0,class:"text-center mb-4"},Ce={class:"text-caption text-medium-emphasis mt-1"},Pe={class:"d-flex align-center justify-center gap-3 mb-4"},Ae={key:1,class:"text-caption text-error text-center mb-3 px-2",style:{"word-break":"break-all"}},Be={class:"d-flex gap-3"},ke={__name:"RecorderPanel",props:{modelValue:Boolean,sentence:{type:String,default:""},nativeAudioB64:{type:String,default:""}},emits:["update:modelValue","close","accept"],setup(e,{emit:n}){const i=e,c=n,l=T({get:()=>i.modelValue,set:m=>c("update:modelValue",m)}),t=V([]),o=V([]),f=V(null),u=V(null),r=V(!1),a=V(!1),g=V(!1),v=V(!1),h=V(null);let s=null,y=null,A=null,C=null;async function w(){if(!C||C.state==="closed"){const m=window.AudioContext||window.webkitAudioContext;C=new m}return C.state==="suspended"&&await C.resume(),C}N(()=>[i.modelValue,i.nativeAudioB64],async([m])=>{if(!m||(u.value=null,o.value=[],f.value=null,t.value=[],!i.nativeAudioB64))return;const d=Uint8Array.from(atob(i.nativeAudioB64),P=>P.charCodeAt(0));y=await H(d.buffer,await w()),t.value=j(y)});async function M(){if(!y||g.value)return;g.value=!0;const m=await w(),d=m.createBufferSource();d.buffer=y,d.connect(m.destination),d.start(),d.onended=()=>{g.value=!1}}async function _(){if(!f.value||v.value)return;v.value=!0;const m=await w(),d=await f.value.arrayBuffer(),P=await m.decodeAudioData(d),b=m.createBufferSource();b.buffer=P,b.connect(m.destination),b.start(),b.onended=()=>{v.value=!1}}async function te(){if(h.value=null,r.value){s==null||s.stop();return}try{const m=await navigator.mediaDevices.getUserMedia({audio:!0}),d=["audio/webm","audio/mp4"].find(b=>MediaRecorder.isTypeSupported(b))??"",P=[];s=new MediaRecorder(m,d?{mimeType:d}:{}),s.ondataavailable=b=>P.push(b.data),s.onstop=async()=>{try{m.getTracks().forEach(b=>b.stop()),r.value=!1,a.value=!0,f.value=new Blob(P,{type:d||"audio/mp4"}),A=await H(await f.value.arrayBuffer(),await w()),o.value=j(A),t.value.length>0&&(u.value=he(t.value,o.value))}catch(b){h.value=`[onstop] ${b.name}: ${b.message}`}finally{a.value=!1}},s.start(),r.value=!0}catch(m){h.value=`[record] ${m.name}: ${m.message}`}}const ae=T(()=>u.value===null?"grey":u.value>=80?"success":u.value>=55?"warning":"error"),ne=T(()=>u.value===null?"":u.value>=80?"Excellent intonation!":u.value>=55?"Good — keep practicing":"Keep trying — record again");return(m,d)=>(E(),se(be,{modelValue:l.value,"onUpdate:modelValue":d[2]||(d[2]=P=>l.value=P),"max-width":"600"},{default:x(()=>[p(ue,{class:"pa-4 pb-6"},{default:x(()=>[k("div",we,S(e.sentence),1),d[7]||(d[7]=k("div",{class:"pitch-legend mb-1 d-flex gap-4 justify-center text-caption"},[k("span",{style:{color:"#22d3ee"}},"— Native"),k("span",{style:{color:"#a78bfa"}},"— You")],-1)),p(me,{"native-curve":t.value,"user-curve":o.value,height:100,class:"mb-4"},null,8,["native-curve","user-curve"]),u.value!==null?(E(),$("div",Ve,[p(ce,{color:ae.value,variant:"tonal",size:"large",class:"text-h6 font-weight-bold px-6"},{default:x(()=>[B(S(u.value)+"% ",1)]),_:1},8,["color"]),k("div",Ce,S(ne.value),1)])):O("",!0),k("div",Pe,[p(q,{icon:"",color:g.value?"primary":void 0,variant:"tonal",onClick:M},{default:x(()=>[p(I,null,{default:x(()=>[B(S(g.value?"mdi-stop":"mdi-volume-high"),1)]),_:1}),p(Y,{activator:"parent"},{default:x(()=>[...d[3]||(d[3]=[B("Play native",-1)])]),_:1})]),_:1},8,["color"]),p(q,{icon:"",size:"x-large",color:r.value?"error":"primary",variant:r.value?"elevated":"tonal",onClick:te,loading:a.value},{default:x(()=>[p(I,null,{default:x(()=>[B(S(r.value?"mdi-stop":"mdi-microphone"),1)]),_:1})]),_:1},8,["color","variant","loading"]),p(q,{icon:"",color:v.value?"secondary":void 0,variant:"tonal",disabled:!f.value,onClick:_},{default:x(()=>[p(I,null,{default:x(()=>[B(S(v.value?"mdi-stop":"mdi-account-voice"),1)]),_:1}),p(Y,{activator:"parent"},{default:x(()=>[...d[4]||(d[4]=[B("Play your recording",-1)])]),_:1})]),_:1},8,["color","disabled"])]),h.value?(E(),$("div",Ae,S(h.value),1)):O("",!0),k("div",Be,[p(q,{variant:"tonal",flex:"1",class:"flex-1",onClick:d[0]||(d[0]=P=>m.$emit("close"))},{default:x(()=>[...d[5]||(d[5]=[B(" Close ",-1)])]),_:1}),p(q,{color:"primary",flex:"1",class:"flex-1",disabled:u.value===null,onClick:d[1]||(d[1]=P=>m.$emit("accept",u.value))},{default:x(()=>[...d[6]||(d[6]=[B(" Accept ",-1)])]),_:1},8,["disabled"])])]),_:1})]),_:1},8,["modelValue"]))}},Ee=J(ke,[["__scopeId","data-v-10e79d3f"]]);export{Ee as R,Y as V};
